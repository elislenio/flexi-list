/*! flexy-list 2015-08-19 */
"use strict";var flexiList=angular.module("flexiList",[]);flexiList.factory("flexiListService",["$log","$filter",function(a,b){return{sortDataset:function(a,c){var d=[];if(c[0]){var e="desc"==c[0].type;d=b("orderBy")(a,c[0].field,e)}else d=a;return d},filterDataset:function(c,d,e){var f,g,h,i,j,k,l=[];if(d.length)for(var m=0;m<c.length;m++){k=!0;for(var n=0;n<d.length;n++)if(f=d[n].field,g=c[m][f],h=d[n].condition,i=d[n].value,j=d[n].option,f&&h){try{k=b(h)(g,i,j)}catch(o){e.err&&a.log(e.id+" - flexiListService: filter exception at ",o),k=!0}if(e.debug&&a.log(e.id+" - filterDataset: value="+g+" condition="+h+" pattern="+i+" passed="+k),!k)break}k&&l.push(c[m])}else l=c;return l},limitDataset:function(a,b){if(!b)return a;var c=[],d=b;d>a.length&&(d=a.length);for(var e=0;d>e;e++)c.push(a[e]);return c},processDataset:function(a,b,c,d,e){var f=this.filterDataset(a,b,e),g=this.sortDataset(f,c),h=this.limitDataset(g,d);return h},pageDataset:function(a,b,c){var d=[],e=b+c;e>a.length&&(e=a.length);for(var f=b;e>f;f++)d.push(a[f]);return d},getPagination:function(a,b,c,d){var e={},f=b/c+1,g=Math.ceil(a/c),h=f-2;1>h&&(h=1);var i=h+d-1,j=i-g;j>0&&(i=g,h-=j,1>h&&(h=1));var k=(f-1)*c+1,l=f*c;l>a&&(l=a);for(var m=[],n=h;i>=n;n++)m.push(n);return e.firstrec=k,e.lastrec=l,e.rowcount=a,e.currpage=f,e.lastpage=i,e.pages=m,e.totalpages=g,e.show_pages=d,e.pagesize=c,e}}}]),flexiList.controller("flMainCtrl",["$scope","$log","$q","$http","$filter","flexiListService",function(a,b,c,d,e,f){function g(){return a.list?(angular.extend(z,a.list.options),a.list.loadData=function(a,b){angular.extend(z,a),b&&(C=0),x()},a.list.change=function(a){w(a)},a.list.refresh=function(){x()},a.list.selectEnabled=function(){return z.selectable},a.list.multiselectEnabled=function(){return z.selectable&&z.multiselect},a.list.paginationEnabled=function(){return z.pagination&&B.length>0?!0:!1},a.list.sortEnabled=function(){return z.sortable},a.list.getRecords=function(){return B},a.list.isEmpty=function(){return 0==B.length&&A},z.sortable&&h(),z.pagination&&o(),z.selectable&&k(),void(z.autoload&&x())):void(z.log.err&&b.log(z.log.id+" - undefined scope."))}function h(){a.list.isSortedAsc=function(a){return E?"asc"==E[a]:!1},a.list.isSortedDesc=function(a){return E?"desc"==E[a]:!1}}function i(a){z.orderby=a,E=j()}function j(){var a=[];if(z.orderby)for(var b=0;b<z.orderby.length;b++)a[z.orderby[b].field]=z.orderby[b].type;return a}function k(){a.list.isRecordSelected=function(a){return a.flSelected?!0:!1},a.list.recordToggleSelect=function(a){a.flSelected?n(a,!1):m(a,!1)},a.list.enforceSelection=function(a){a.flSelected?m(a,!0):n(a,!0)},a.list.getToggleSelNextState=function(){return H},z.multiselect&&(a.list.toggleSelectAll=function(){B&&(H=!H,l(H,!0))}),a.list.getSelectedCount=function(){return G},a.list.getSelectedRecords=function(){var a=[];return B&&angular.forEach(B,function(b){b.flSelected&&a.push(b)}),a}}function l(a,b){b?angular.forEach(B,function(b){a?m(b,!1):n(b,!1)}):angular.forEach(D,function(b){a?m(b,!1):n(b,!1)})}function m(a,b){a.readonly||(b||!a.flSelected)&&(z.multiselect?(a.flSelected=!0,G++):(F&&(F.flSelected=!1),a.flSelected=!0,F=a,G=1))}function n(a,b){a.readonly||(b||a.flSelected)&&(z.multiselect?(a.flSelected=!1,G--):(F=!1,a.flSelected=!1,G=0))}function o(){a.list.getPagination=function(){return I},a.list.changePage=function(a){p(a)},a.list.setPageSize=function(a){z.pagesize=a,p(1)}}function p(b){1>b||b>I.totalpages||(a.$emit("flStartOp",{op:"getPage"}),z.selectable&&z.pagination_clear_selection&&l(!1,!1),C=(b-1)*z.pagesize,z.paginationOnClient?(B=f.pageDataset(D,C,z.pagesize),I=f.getPagination(y,C,z.pagesize,z.pages),a.$emit("flComplete",{result:"OK"})):x())}function q(){var a=c.defer(),e={};if(e.where=z.where,e.orderby=z.orderby,z.limit&&(e.limit=z.limit),z.pagination&&!z.paginationOnClient&&(e.offset=C,e.pagesize=z.pagesize),z.urlencoded)if("GET"==z.method){var f=z.listURL+"?"+jQuery.param(e);z.log.debug&&b.log(z.log.id+" URL: "+f),d({method:"GET",url:f}).success(function(b,c){a.resolve(b)}).error(function(b,c){a.reject("ERROR: "+c)})}else d({method:"POST",url:z.listURL,data:jQuery.param(e),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,c){a.resolve(b)}).error(function(b,c){a.reject("ERROR: "+c)});else"GET"==z.method?d({method:"GET",url:z.listURL,params:e}).success(function(b,c){a.resolve(b)}).error(function(b,c){a.reject("ERROR: "+c)}):d.post(z.listURL,e).success(function(b,c){a.resolve(b)}).error(function(b,c){a.reject("ERROR: "+c)});return a.promise}function r(){var a=c.defer();return d({method:"GET",url:z.jsonFile}).success(function(b,c){a.resolve(b)}).error(function(b,c){a.reject("ERROR: "+c)}),a.promise}function s(){z.paginationOnClient=!0,A=z.data,A||(A=[],z.log.err&&b.log(z.log.id+" - Load Error.")),D=f.processDataset(z.data,z.where,z.orderby,z.limit,z.log),y=D.length,z.pagination?(B=f.pageDataset(D,C,z.pagesize),I=f.getPagination(y,C,z.pagesize,z.pages)):B=D,E=j()}function t(){D=f.processDataset(A,z.where,z.orderby,z.limit,z.log),y=D.length,z.pagination?(B=f.pageDataset(D,C,z.pagesize),I=f.getPagination(y,C,z.pagesize,z.pages)):B=D}function u(){z.paginationOnClient=!0;var c=r();c.then(function(c){z.log.debug&&b.log(z.log.id+" - Data: "+e("json")(c)),c||(c=[]),A=c,t(),E=j(),a.$emit("flComplete",{result:"OK"})},function(c){A=[],B=[],z.log.err&&b.log(z.log.id+" - Load Error: "+c),a.$emit("flComplete",{result:"ERROR",message:c})})}function v(){var c=q();c.then(function(c){a.list.server_response=c,z.log.debug&&b.log(z.log.id+" - Data: "+e("json")(c)),c?"OK"!=c.result&&z.log.err&&b.log(z.log.id+" - data.result: "+c.result):c={},c.records||(c.records=[]),A=c.records,c.orderby&&i(c.orderby),y=c.rowcount,D=c.records,z.pagination?z.paginationOnClient?(B=f.pageDataset(D,C,z.pagesize),I=f.getPagination(y,C,z.pagesize,z.pages)):(B=c.records,I=f.getPagination(y,c.offset,z.pagesize,z.pages)):B=c.records,"OK"!=c.result?a.$emit("flComplete",{result:"ERROR",message:c.result}):a.$emit("flComplete",{result:"OK"})},function(c){A=[],B=[],z.log.err&&b.log(z.log.id+" - Load Error: "+c),a.$emit("flComplete",{result:"ERROR",message:c})})}function w(b){a.$emit("flStartOp",{op:"change"}),angular.extend(z,b),z.selectable&&l(!1,!1),C=0,t(),E=j(),a.$emit("flComplete",{result:"OK"})}function x(){a.$emit("flStartOp",{op:"loadData"}),G=0,z.data?(s(),a.$emit("flComplete",{result:"OK"})):z.jsonFile?u():z.listURL?v():(z.log.err&&b.log(z.log.id+" - Undefined data source."),a.$emit("flComplete",{result:"ERROR",message:"Undefined data source"}))}var y,z={data:!1,jsonFile:!1,listURL:!1,autoload:!0,selectable:!0,multiselect:!0,limit:!1,where:[],sortable:!0,orderby:[],pagination:!0,paginationOnClient:!1,pagination_clear_selection:!0,pagesize:10,pages:5,method:"GET",urlencoded:!0,log:{id:"FL",err:!1,debug:!1}},A=!1,B=[],C=0;g();var D,E=[],F=!1,G=0,H=!1,I={}}]),flexiList.directive("flMain",function(){return{restrict:"E",scope:{list:"="},controller:"flMainCtrl"}}),flexiList.filter("eq",function(){return function(a,b,c){return void 0==a||void 0==b?!0:c?a.toLowerCase()==b.toLowerCase():a==b}}),flexiList.filter("ne",function(){return function(a,b){return void 0==a||void 0==b?!0:a!=b}}),flexiList.filter("gt",function(){return function(a,b){return void 0==a||void 0==b?!0:a>b}}),flexiList.filter("ge",function(){return function(a,b){return void 0==a||void 0==b?!0:a>=b}}),flexiList.filter("lt",function(){return function(a,b){return void 0==a||void 0==b?!0:b>a}}),flexiList.filter("le",function(){return function(a,b){return void 0==a||void 0==b?!0:b>=a}}),flexiList.filter("like_l",function(){return function(a,b,c){return void 0==a||void 0==b?!0:c?-1!==a.toLowerCase().indexOf(b.toLowerCase(),a.length-b.length):-1!==a.indexOf(b,a.length-b.length)}}),flexiList.filter("like_r",function(){return function(a,b,c){return void 0==a||void 0==b?!0:c?0===a.toLowerCase().indexOf(b.toLowerCase()):0===a.indexOf(b)}}),flexiList.filter("like_b",function(){return function(a,b,c){return void 0==a||void 0==b?!0:c?-1!==a.toLowerCase().indexOf(b.toLowerCase()):-1!==a.indexOf(b)}}),flexiList.filter("is_null",function(){return function(a,b){return void 0==a?!0:0==a.toString().length}}),flexiList.filter("is_not_null",function(){return function(a,b){return void 0==a?!1:a.toString().length>0}}),flexiList.filter("regexp",function(){return function(a,b,c){if(void 0==a||void 0==b)return!0;var d=new RegExp(b,c);return d.test(a)}});